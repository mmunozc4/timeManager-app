<main class="business-appointments-container">
  <header class="page-header">
    <h1 class="page-title">Mis Citas de Negocio</h1>
  </header>

  <section class="filters-section card-style">
    <form [formGroup]="filterForm" class="filter-form">
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Fecha</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="date">
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Estado</mat-label>
        <mat-select formControlName="status">
          <mat-option value="">Todos</mat-option>
          <mat-option value="pending">Pendiente</mat-option>
          <mat-option value="accepted">Aceptada</mat-option>
          <mat-option value="cancelled">Cancelada</mat-option>
          <mat-option value="completed">Completada</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Cliente</mat-label>
        <input matInput placeholder="Buscar cliente" formControlName="client">
      </mat-form-field>
    </form>
  </section>

  <section class="status-messages">
    <p *ngIf="loading" class="loading-message">Cargando citas...</p>
    <p *ngIf="errorMessage" class="error-message">{{ errorMessage }}</p>
    <div *ngIf="!loading && filteredAppointments.data.length === 0" class="empty-state">
      <p>No tienes citas programadas que coincidan con los filtros.</p>
    </div>
  </section>

  <div *ngIf="!loading && filteredAppointments.data.length > 0" class="appointments-table-wrapper card-style">
    <table mat-table [dataSource]="filteredAppointments" class="modern-appointment-table">

      <ng-container matColumnDef="client">
        <th mat-header-cell *matHeaderCellDef> Cliente </th>
        <td mat-cell *matCellDef="let element"> {{element.client?.full_name}} </td>
      </ng-container>

      <ng-container matColumnDef="employee">
        <th mat-header-cell *matHeaderCellDef> Empleado </th>
        <td mat-cell *matCellDef="let element"> {{element.employee?.name}} </td>
      </ng-container>

      <ng-container matColumnDef="service">
        <th mat-header-cell *matHeaderCellDef> Servicio </th>
        <td mat-cell *matCellDef="let element"> {{element.service?.name}} </td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Fecha </th>
        <td mat-cell *matCellDef="let element"> {{element.appointment_time | date:'short'}} </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Estado </th>
        <td mat-cell *matCellDef="let element">
          <span class="status-badge {{ element.status | lowercase }}">
            {{ element.status }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Acciones </th>
        <td mat-cell *matCellDef="let element" class="actions-cell">
          <button mat-flat-button color="primary" class="action-button accept-button" (click)="updateStatus(element.id, 'accepted')" [disabled]="element.status==='accepted'">
            Aceptar
          </button>
          <button mat-flat-button color="warn" class="action-button cancel-button" (click)="updateStatus(element.id, 'cancelled')" [disabled]="element.status==='cancelled'">
            Cancelar
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['client', 'employee','service', 'date', 'status', 'actions']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['client', 'employee','service', 'date', 'status', 'actions']"></tr>
    </table>
  </div>
</main>